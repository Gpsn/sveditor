<project name="mk_product" default="mk_product">
	
	<property name="srcdir" value="${basedir}/../"/>
	<property environment="env"/>
	
	<!-- Import the version info -->
	<property file="${basedir}/../sveditor.info"/>
	<property environment="env"/>
	<property name="feature.version" value="${version}"/>

	<property name="buildRoot" location="${basedir}/../buildRoot"/>
	<property name="buildRun" location="${buildRoot}/buildRun"/>
	<property name="build" location="${buildRoot}/build"/>
	<property name="buildResult" location="${basedir}/../buildResult"/>
	<property name="builder" value="${buildRoot}/builder"/>
	<property name="installerTmp" value="${basedir}/../installerTmp"/>

	<property file="${basedir}/mk_product.properties"/>
	<property file="${basedir}/mk_product_${os}.properties"/>
	<property name="eclipse.home" location="${env.ECLIPSE_HOME}"/>

	<condition property="is_win">
		<os family="windows"/>
	</condition>

	<target name="mk_product" depends="build_archive">
		<antcall target="mk_msi"/>
	</target>

	<target name="mk_msi" if="is_win">
		<delete dir="${installerTmp}"/>
		<mkdir dir="${installerTmp}"/>
		<unzip dest="${installerTmp}">
			<fileset dir="${buildResult}">
				<include name="sve-${os}.*.x86_64.zip"/>
			</fileset>
		</unzip>
		<ant antfile="${basedir}/mk_msi.xml" 
			dir="${installerTmp}/sve">
			<property name="script.dir" value="${basedir}"/>
			<property name="dest" 
				value="${buildResult}/sve-x86_64.msi"/>
		</ant>
		<delete dir="${installerTmp}"/>
		<mkdir dir="${installerTmp}"/>
		<unzip dest="${installerTmp}">
			<fileset dir="${buildResult}">
				<include name="sve-${os}.*.x86.zip"/>
			</fileset>
		</unzip>
		<ant antfile="${basedir}/mk_msi.xml" 
			dir="${installerTmp}/sve">
			<property name="script.dir" value="${basedir}"/>
			<property name="dest" 
				value="${buildResult}/sve-x86.msi"/>
		</ant>
	</target>

	<target name="build_archive">

		<delete dir="${buildRoot}"/> 
		<mkdir dir="${buildRoot}"/> 
		<mkdir dir="${buildRun}"/> 
		<mkdir dir="${build}"/> 
		<mkdir dir="${buildResult}"/> 
		<property name="baseLocation" value="${eclipse.home}"/>
		<copy todir="${build}">
			<fileset dir="${srcdir}">
				<include name="plugins/**"/>
				<include name="features/**"/>
				<exclude name="**/*.svn/**"/>
				<exclude name="**/*.git/**"/>
			</fileset>
		</copy>
		<copy todir="${build}" overwrite="true">
			<fileset dir="${srcdir}">
				<include name="features/**/*.xml"/>
				<include name="features/**/*.product"/>
				<include name="plugins/**/*.xml"/>
				<include name="plugins/**/*.MF"/>
				<include name="plugins/**/*.properties"/>
			</fileset>
			<filterset begintoken="1" endtoken="3">
				<filter token=".2." value="${feature.version}"/>
			</filterset>
		</copy>
		<copy file="${basedir}/mk_product_1.xml" todir="${buildRun}"/>
		<ant antfile="${buildRun}/mk_product_1.xml" dir="${buildRun}"/>

		<copy todir="${buildResult}">
			<fileset dir="${build}/I.sve">
				<include name="*.zip"/>
			</fileset>
		</copy>
		<delete dir="${buildRoot}"/>
	</target>

</project>
